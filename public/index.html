<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM Processor - Upload & Process Medical Images</title>
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">üìä DICOM Processor V1.5</div>
                <nav>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="#uploads">Uploads</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Hero Section -->
        <section class="text-center mt-xl mb-xl fade-in">
            <h1>Medical Image Processing</h1>
            <p style="font-size: 1.125rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto;">
                Upload your DICOM files and automatically generate JPG previews, bump maps, and 3D volumetric data for
                visualization, vti and nrrd files.
            </p>
        </section>

        <!-- Upload Section -->
        <section class="card mb-xl fade-in">
            <h2 class="card-title">üì§ Upload DICOM Files</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Drop files here</h3>
                    <p style="color: var(--text-muted); margin-bottom: var(--spacing-lg);">
                        ZIP archives, .dcm files, or use the buttons below
                    </p>
                    <input type="file" id="fileInput" name="files" accept=".zip,.dcm" multiple style="display: none;">
                    <input type="file" id="folderInput" name="files" webkitdirectory style="display: none;">
                    <div class="flex gap-sm justify-center flex-wrap">
                        <button type="button" class="btn btn-primary"
                            onclick="document.getElementById('fileInput').click()">
                            Select Files
                        </button>
                        <button type="button" class="btn btn-secondary"
                            onclick="document.getElementById('folderInput').click()">
                            Select Folder
                        </button>
                    </div>
                </div>

                <div id="fileList" class="hidden mt-lg" style="color: var(--text-secondary); font-size: 0.875rem;">
                </div>

                <div id="uploadProgress" class="hidden mt-lg">
                    <div class="flex items-center justify-between mb-sm">
                        <span id="uploadStatus">Uploading...</span>
                        <span id="uploadPercent">0%</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <div id="uploadResult" class="hidden mt-lg"></div>
            </form>
        </section>

        <!-- Uploads Grid -->
        <section id="uploads">
            <div class="flex items-center justify-between mb-lg">
                <h2>Recent Uploads</h2>
                <span class="badge badge-success" id="uploadCount">Loading...</span>
            </div>

            <div id="uploadsGrid" class="grid grid-3">
                <div class="text-center" style="grid-column: 1 / -1;">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // File upload handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const uploadForm = document.getElementById('uploadForm');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadPercent = document.getElementById('uploadPercent');
        const progressBar = document.getElementById('progressBar');
        const uploadResult = document.getElementById('uploadResult');
        const fileListDiv = document.getElementById('fileList');

        // Drag and drop handlers
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragging');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragging');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragging');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleUpload(files);
            }
        });

        // File input change handler
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleUpload(fileInput.files);
            }
        });

        // Folder input change handler
        folderInput.addEventListener('change', () => {
            if (folderInput.files.length > 0) {
                handleUpload(folderInput.files);
            }
        });

        // Handle file upload
        async function handleUpload(files) {
            if (!files || files.length === 0) {
                alert('No files selected');
                return;
            }

            // Filter to only .zip and .dcm files (skip others client-side for folder uploads)
            const validFiles = [];
            const skippedCount = { count: 0 };
            for (const file of files) {
                const name = file.name.toLowerCase();
                if (name.endsWith('.zip') || name.endsWith('.dcm')) {
                    validFiles.push(file);
                } else {
                    skippedCount.count++;
                }
            }

            if (validFiles.length === 0) {
                alert('No .zip or .dcm files found in the selection');
                return;
            }

            // Show file list
            const fileNames = validFiles.slice(0, 5).map(f => f.name);
            let listText = `Uploading ${validFiles.length} file${validFiles.length > 1 ? 's' : ''}: ${fileNames.join(', ')}`;
            if (validFiles.length > 5) listText += ` and ${validFiles.length - 5} more`;
            if (skippedCount.count > 0) listText += ` (skipping ${skippedCount.count} non-DICOM file${skippedCount.count > 1 ? 's' : ''})`;
            fileListDiv.textContent = listText;
            fileListDiv.classList.remove('hidden');

            const formData = new FormData();
            for (const file of validFiles) {
                formData.append('files', file);
            }

            uploadProgress.classList.remove('hidden');
            uploadResult.classList.add('hidden');
            uploadStatus.textContent = `Uploading ${validFiles.length} file${validFiles.length > 1 ? 's' : ''}...`;

            try {
                const xhr = new XMLHttpRequest();

                let statusInterval = null;

                function startStatusPolling() {
                    statusInterval = setInterval(async () => {
                        try {
                            const resp = await fetch('/processing-status');
                            const data = await resp.json();
                            if (data.status) {
                                uploadStatus.textContent = data.status;
                            }
                        } catch { }
                    }, 500);
                }

                function stopStatusPolling() {
                    if (statusInterval) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                    }
                }

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        uploadPercent.textContent = `${percent}%`;
                        progressBar.style.width = `${percent}%`;

                        if (percent === 100 && !statusInterval) {
                            uploadStatus.textContent = 'Processing DICOM files...';
                            startStatusPolling();
                        }
                    }
                });

                xhr.addEventListener('load', () => {
                    stopStatusPolling();
                    fileListDiv.classList.add('hidden');
                    if (xhr.status === 200) {
                        const result = JSON.parse(xhr.responseText);
                        showUploadSuccess(result);
                        setTimeout(() => {
                            loadUploads();
                        }, 1000);
                    } else {
                        const error = JSON.parse(xhr.responseText);
                        showUploadError(error.message || 'Upload failed');
                    }
                });

                xhr.addEventListener('error', () => {
                    stopStatusPolling();
                    fileListDiv.classList.add('hidden');
                    showUploadError('Network error occurred');
                });

                xhr.open('POST', '/upload');
                xhr.send(formData);

            } catch (error) {
                fileListDiv.classList.add('hidden');
                showUploadError(error.message);
            }
        }

        function showUploadSuccess(result) {
            uploadProgress.classList.add('hidden');
            uploadResult.classList.remove('hidden');

            let skippedHtml = '';
            if (result.skipped && result.skipped.length > 0) {
                skippedHtml = `<p style="color: var(--text-muted); font-size: 0.875rem; margin-top: var(--spacing-sm);">Skipped: ${result.skipped.join(', ')}</p>`;
            }

            uploadResult.innerHTML = `
                <div class="card" style="background: rgba(16, 185, 129, 0.1); border-color: var(--success);">
                    <h3 style="color: var(--success); margin-bottom: var(--spacing-md);">‚úì Processing Complete</h3>
                    <div class="flex gap-md" style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                        <span>üìÅ Folder: ${result.folder}</span>
                        <span>üìÑ Files: ${result.processedFiles.length}</span>
                    </div>
                    ${skippedHtml}
                    <div class="flex gap-sm flex-wrap">
                        <a href="/json-viewer.html?path=${encodeURIComponent(result.jsonPath)}" target="_blank" class="btn btn-secondary">View JSON</a>
                        <a href="/webvr-viewer.html?file=${encodeURIComponent(result.vtiPaths[0])}" target="_blank" class="btn btn-secondary">ü•Ω WebVR (VTI)</a>
                        <a href="/webvr-viewer.html?file=${encodeURIComponent(result.nrrdPaths[0])}" target="_blank" class="btn btn-secondary">ü•Ω WebVR (NRRD)</a>
                        <a href="/VolumeViewer.html?fileURL=${encodeURIComponent(result.vtiPaths[0])}" target="_blank" class="btn btn-secondary">View 3D (VTI)</a>
                        <a href="/volume-viewer.html?file=${encodeURIComponent(result.vtiPaths[0])}" target="_blank" class="btn btn-secondary">Volume (VTI)</a>
                        <a href="/volume-viewer.html?file=${encodeURIComponent(result.nrrdPaths[0])}" target="_blank" class="btn btn-secondary">Volume (NRRD)</a>
                        <a href="/volume-viewer.html?file=${encodeURIComponent(result.niftiPaths[0])}" target="_blank" class="btn btn-secondary">Volume (NIfTI)</a>
                        <a href="/stl-viewer.html?file=${encodeURIComponent(result.stlPaths[0])}" target="_blank" class="btn btn-secondary">View 3D (STL)</a>
                        <a href="/volume-viewer.html?file=${encodeURIComponent(result.vtkLegacyPaths[0])}" target="_blank" class="btn btn-secondary">Volume (VTK)</a>
                        ${result.mprPaths && result.mprPaths[0] ? `<a href="/mpr-viewer.html?info=${encodeURIComponent(result.mprPaths[0])}" target="_blank" class="btn btn-secondary">MPR Viewer</a>` : ''}
                        <a href="/folder-viewer.html?folder=${encodeURIComponent(result.folder)}" class="btn btn-primary">Browse Files</a>
                    </div>
                </div>
            `;
            fileInput.value = '';
            folderInput.value = '';
        }

        function showUploadError(message) {
            uploadProgress.classList.add('hidden');
            uploadResult.classList.remove('hidden');
            uploadResult.innerHTML = `
                <div class="card" style="background: rgba(239, 68, 68, 0.1); border-color: var(--error);">
                    <h3 style="color: var(--error);">‚úó Upload Failed</h3>
                    <p style="color: var(--text-secondary);">${message}</p>
                </div>
            `;
        }

        // Load uploads
        async function loadUploads() {
            try {
                const response = await fetch('/list-uploads');
                const data = await response.json();

                const uploadsGrid = document.getElementById('uploadsGrid');
                const uploadCount = document.getElementById('uploadCount');

                if (data.folders.length > 0) {
                    uploadCount.innerHTML = `<a href="/json-viewer.html?path=${encodeURIComponent(data.indexPath)}" target="_blank" style="color: inherit; text-decoration: none; border-bottom: 1px dashed currentColor;">${data.folders.length} uploads</a>`;
                } else {
                    uploadCount.textContent = `${data.folders.length} uploads`;
                }

                if (data.folders.length === 0) {
                    uploadsGrid.innerHTML = `
                        <div class="text-center" style="grid-column: 1 / -1; padding: var(--spacing-2xl);">
                            <div style="font-size: 4rem; opacity: 0.3; margin-bottom: var(--spacing-md);">üìÇ</div>
<p style="color: var(--text-muted);">No uploads yet. Upload your first DICOM files to get started!</p>
                        </div>
                    `;
                    return;
                }

                uploadsGrid.innerHTML = data.folders.map((folder, index) => {
                    const parts = folder.path.split('/');
                    const dirName = parts[parts.length - 2];
                    const folderName = dirName.split('_').slice(1).join('_') || `Upload ${index + 1}`;
                    const timestamp = dirName.split('_')[0];
                    const date = new Date(parseInt(timestamp));

                    return `
                        <div class="folder-card fade-in" style="animation-delay: ${index * 0.1}s;">
                            <div class="folder-thumbnail">
                                <span>üè•</span>
                            </div>
                            <div class="folder-info">
                                <div class="folder-name">${folderName}</div>
                                <div class="folder-meta">
                                    <span>üìÖ ${date.toLocaleDateString()}</span>
                                    <span>‚è∞ ${date.toLocaleTimeString()}</span>
                                </div>
                                <div class="folder-actions">
                                    <a href="/json-viewer.html?path=${encodeURIComponent(folder.path)}" target="_blank" class="action-btn">üìÑ JSON</a>
                                    <a href="/webvr-viewer.html?file=${encodeURIComponent(folder.vtiPath)}" target="_blank" class="action-btn">ü•Ω VR (VTI)</a>
                                    <a href="/webvr-viewer.html?file=${encodeURIComponent(folder.nrrdPath)}" target="_blank" class="action-btn">ü•Ω VR (NRRD)</a>
                                    <a href="/VolumeViewer.html?fileURL=${encodeURIComponent(folder.vtiPath)}" target="_blank" class="action-btn">üéÆ VTI (old)</a>
                                    <a href="/volume-viewer.html?file=${encodeURIComponent(folder.vtiPath)}" target="_blank" class="action-btn">üéÆ VTI</a>
                                    <a href="/volume-viewer.html?file=${encodeURIComponent(folder.nrrdPath)}" target="_blank" class="action-btn">üéÆ NRRD</a>
                                    <a href="/volume-viewer.html?file=${encodeURIComponent(folder.niftiPath)}" target="_blank" class="action-btn">üéÆ NIfTI</a>
                                    <a href="/stl-viewer.html?file=${encodeURIComponent(folder.stlPath)}" target="_blank" class="action-btn">üéÆ STL</a>
                                    <a href="/volume-viewer.html?file=${encodeURIComponent(folder.vtkLegacyPath)}" target="_blank" class="action-btn">üéÆ VTK</a>
                                    ${folder.mprPath ? `<a href="/mpr-viewer.html?info=${encodeURIComponent(folder.mprPath)}" target="_blank" class="action-btn">üî¨ MPR</a>` : ''}
                                    <a href="/folder-viewer.html?path=${encodeURIComponent(folder.path)}" class="action-btn">üìÅ Browse</a>
                                    <button onclick="showDeleteModal('${folder.path}')" class="action-btn" style="border-color: var(--error); color: var(--error);">üóë Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading uploads:', error);
                document.getElementById('uploadsGrid').innerHTML = `
                    <div class="text-center" style="grid-column: 1 / -1;">
                        <p style="color: var(--error);">Error loading uploads</p>
                    </div>
                `;
            }
        }

        // Load uploads on page load
        document.addEventListener('DOMContentLoaded', loadUploads);

        // Delete functionality
        let itemToDelete = null;
        // Elements will be captured when functions run or we can move script to end of body

        function showDeleteModal(path) {
            itemToDelete = path;
            document.getElementById('deleteModal').classList.add('show');
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            itemToDelete = null;
        }

        async function confirmDelete() {
            if (!itemToDelete) return;

            const btn = document.getElementById('confirmDeleteBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            try {
                const response = await fetch('/delete-upload', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ folderPath: itemToDelete })
                });

                const result = await response.json();

                if (result.success) {
                    hideDeleteModal();
                    loadUploads(); // Refresh list
                } else {
                    alert('Error deleting: ' + result.message);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete item');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    </script>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: var(--error);">‚ö†Ô∏è Confirm Deletion</h3>
            <p style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">
                Are you sure you want to delete this upload? This action cannot be undone.
            </p>
            <div class="modal-actions">
                <button onclick="hideDeleteModal()" class="btn btn-ghost">Cancel</button>
                <button id="confirmDeleteBtn" onclick="confirmDelete()" class="btn btn-primary"
                    style="background: var(--error); border: none;">Delete</button>
            </div>
        </div>
    </div>
</body>

</html>