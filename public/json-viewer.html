<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Viewer - DICOM Processor</title>
    <meta name="description"
        content="View and explore DICOM metadata in JSON format. Browse structured DICOM header information with syntax highlighting and tree navigation.">
    <meta name="keywords"
        content="DICOM, JSON viewer, DICOM metadata, DICOM header, medical imaging metadata, DICOM tags">
    <meta name="author" content="DICOM Processor">
    <meta property="og:title" content="JSON Viewer - DICOM Processor">
    <meta property="og:description"
        content="View and explore DICOM metadata in JSON format. Browse structured DICOM header information with syntax highlighting and tree navigation.">
    <meta property="og:type" content="website">
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        .json-viewer {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            overflow-x: auto;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .json-key {
            color: #8b5cf6;
            font-weight: 600;
        }

        .json-string {
            color: #10b981;
        }

        .json-number {
            color: #06b6d4;
        }

        .json-boolean {
            color: #f59e0b;
        }

        .json-null {
            color: #94a3b8;
        }

        .json-bracket {
            color: var(--text-primary);
            font-weight: 600;
        }

        .json-line {
            margin: 2px 0;
        }

        .json-collapsible {
            cursor: pointer;
            user-select: none;
        }

        .json-collapsible:hover {
            background: var(--glass-bg);
        }

        .json-collapsed {
            display: none;
        }

        .json-toggle {
            display: inline-block;
            width: 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .search-box {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: var(--spacing-lg);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .highlight {
            background: rgba(245, 158, 11, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .toolbar {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            align-items: center;
        }

        .stats {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            flex: 1;
            min-width: 200px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: var(--spacing-sm);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">üìä DICOM Processor</div>
                <nav>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="/#uploads">Uploads</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="mt-xl mb-lg">
            <a href="/" class="btn btn-ghost" style="margin-bottom: var(--spacing-lg);">‚Üê Back to Home</a>
            <h1 id="pageTitle">JSON Viewer</h1>
        </section>

        <section class="stats">
            <div class="stat-card">
                <div class="stat-value" id="fileCount">-</div>
                <div class="stat-label">Total DICOM Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="imageCount">-</div>
                <div class="stat-label">Images Generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bumpmapCount">-</div>
                <div class="stat-label">Bump Maps</div>
            </div>
        </section>

        <section class="card">
            <div class="toolbar">
                <input type="text" id="searchBox" class="search-box" placeholder="üîç Search JSON...">
                <button class="btn btn-secondary" onclick="expandAll()">Expand All</button>
                <button class="btn btn-secondary" onclick="collapseAll()">Collapse All</button>
                <button class="btn btn-primary" onclick="copyToClipboard()">üìã Copy JSON</button>
                <button class="btn btn-primary" onclick="downloadJSON()">‚¨áÔ∏è Download</button>
            </div>
            <div id="jsonPathDisplay"
                style="font-family: monospace; color: var(--text-muted); margin-bottom: var(--spacing-md); word-break: break-all; padding: 0 var(--spacing-sm);">
            </div>

            <div id="jsonViewer" class="json-viewer">
                <div class="spinner"></div>
            </div>
        </section>
    </main>

    <script>
        let jsonData = null;
        let jsonPath = null;

        async function loadJSON() {
            const urlParams = new URLSearchParams(window.location.search);
            jsonPath = urlParams.get('path');

            if (!jsonPath) {
                alert('No JSON path specified');
                window.location.href = '/';
                return;
            }

            try {
                const response = await fetch(jsonPath);
                jsonData = await response.json();

                renderStats();
                renderJSON();

                // Update page title
                const parts = jsonPath.split('/');
                const dirName = parts[parts.length - 2];
                const folderName = dirName.split('_').slice(1).join('_') || 'DICOM Data';
                document.getElementById('pageTitle').textContent = `${folderName} - JSON Data`;
                document.getElementById('jsonPathDisplay').textContent = window.location.origin + jsonPath;

            } catch (error) {
                console.error('Error loading JSON:', error);
                document.getElementById('jsonViewer').innerHTML = '<p style="color: var(--error);">Error loading JSON data</p>';
            }
        }

        function renderStats() {
            if (Array.isArray(jsonData)) {
                document.getElementById('fileCount').textContent = jsonData.length;
                document.getElementById('imageCount').textContent = jsonData.filter(f => f.jpgPath).length;
                document.getElementById('bumpmapCount').textContent = jsonData.filter(f => f.bumpMapPath).length;
            } else {
                document.getElementById('fileCount').textContent = '1';
                document.getElementById('imageCount').textContent = '-';
                document.getElementById('bumpmapCount').textContent = '-';
            }
        }

        function renderJSON() {
            const viewer = document.getElementById('jsonViewer');
            viewer.innerHTML = syntaxHighlight(jsonData, 0);
        }

        function syntaxHighlight(obj, level) {
            if (obj === null) {
                return '<span class="json-null">null</span>';
            }

            if (typeof obj === 'string') {
                return `<span class="json-string">"${escapeHtml(obj)}"</span>`;
            }

            if (typeof obj === 'number') {
                return `<span class="json-number">${obj}</span>`;
            }

            if (typeof obj === 'boolean') {
                return `<span class="json-boolean">${obj}</span>`;
            }

            const indent = '  '.repeat(level);
            const nextIndent = '  '.repeat(level + 1);

            if (Array.isArray(obj)) {
                if (obj.length === 0) {
                    return '<span class="json-bracket">[]</span>';
                }

                const id = 'collapse_' + Math.random().toString(36).substr(2, 9);
                let html = `<span class="json-collapsible" onclick="toggleCollapse('${id}')">`;
                html += `<span class="json-toggle" id="toggle_${id}">‚ñº</span>`;
                html += `<span class="json-bracket">[</span></span>`;
                html += `<div id="${id}">`;

                obj.forEach((item, i) => {
                    html += `<div class="json-line">${nextIndent}${syntaxHighlight(item, level + 1)}`;
                    if (i < obj.length - 1) html += ',';
                    html += '</div>';
                });

                html += `</div><div class="json-line">${indent}<span class="json-bracket">]</span></div>`;
                return html;
            }

            if (typeof obj === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) {
                    return '<span class="json-bracket">{}</span>';
                }

                const id = 'collapse_' + Math.random().toString(36).substr(2, 9);
                let html = `<span class="json-collapsible" onclick="toggleCollapse('${id}')">`;
                html += `<span class="json-toggle" id="toggle_${id}">‚ñº</span>`;
                html += `<span class="json-bracket">{</span></span>`;
                html += `<div id="${id}">`;

                keys.forEach((key, i) => {
                    html += `<div class="json-line">${nextIndent}`;
                    html += `<span class="json-key">"${escapeHtml(key)}"</span>: `;
                    html += syntaxHighlight(obj[key], level + 1);
                    if (i < keys.length - 1) html += ',';
                    html += '</div>';
                });

                html += `</div><div class="json-line">${indent}<span class="json-bracket">}</span></div>`;
                return html;
            }

            return String(obj);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleCollapse(id) {
            const element = document.getElementById(id);
            const toggle = document.getElementById('toggle_' + id);

            if (element.style.display === 'none') {
                element.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                element.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            }
        }

        function expandAll() {
            document.querySelectorAll('[id^="collapse_"]').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('[id^="toggle_"]').forEach(el => {
                el.textContent = '‚ñº';
            });
        }

        function collapseAll() {
            document.querySelectorAll('[id^="collapse_"]').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('[id^="toggle_"]').forEach(el => {
                el.textContent = '‚ñ∂';
            });
        }

        function copyToClipboard() {
            const text = JSON.stringify(jsonData, null, 2);
            navigator.clipboard.writeText(text).then(() => {
                alert('JSON copied to clipboard!');
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
            });
        }

        function downloadJSON() {
            const text = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = jsonPath.split('/').pop() || 'data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const viewer = document.getElementById('jsonViewer');

            if (!query) {
                renderJSON();
                return;
            }

            // Simple search - re-render with highlighting
            const highlighted = JSON.stringify(jsonData, null, 2)
                .split('\n')
                .map(line => {
                    if (line.toLowerCase().includes(query)) {
                        return line.replace(new RegExp(`(${query})`, 'gi'), '<span class="highlight">$1</span>');
                    }
                    return line;
                })
                .join('\n');

            viewer.innerHTML = `<pre style="margin: 0; color: var(--text-secondary);">${highlighted}</pre>`;
        });

        // Load JSON on page load
        document.addEventListener('DOMContentLoaded', loadJSON);
    </script>
</body>

</html>